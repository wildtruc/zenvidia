#! /bin/bash

#  Zen_notify
#  mar. oct. 11 16:21:02 CEST 2016
#  Copyright  2010-2016  PirateProd
#  <wildtruc@noneltd.net>
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public
#  License as published by the Free Software Foundation; either
#  version 2.1 of the License, or (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#  Lesser General Public License for more details.
#
#  You should have received a copy of the GNU Lesser General Public
#  License along with main.c;if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor Boston, MA 02110-1301,  USA

## basics
local_nvdir=/home/$USER/.zenvidia
nvdir=/usr/local/zenvidia
script_conf=$nvdir/script.conf
basic_conf=$local_nvdir/basic.conf
nvtmp=$local_nvdir/notify
deficon=swiss_knife
[ $script_conf ] || exit 0
. $script_conf
. $basic_conf
## script could need to sleep during the desktop session boot time.
## to uncomment only in case of session autostart notif issue.
# sleep 15
ifs=$IFS

[ -d $nvtmp ] || mkdir -p $nvtmp
ARCH=$(uname -p)
drv_temp=$(mktemp --tmpdir zen_notif-XXXX)
drv_list=$nvtmp/drvlist
last_update=$nvtmp/last_update
last_beta=$nvtmp/last_beta
local_src=$local_nvdir/src
[ -d $local_src ] || mkdir -p $local_src
## reset all notif display options
driver_up=0
zen_up=0

driver_ctrl(){
## default driver caracters max count.
nb=9
## get all driver list.
wget -q -O $drv_temp https://$nvidia_ftp-$ARCH/
## get latest.txt file.
wget -q -O $last_update https://$nvidia_ftp-$ARCH/latest.txt
## latest.txt fiel dfine current official version.
## end of all driver list define the beta version if different from diiferent of official.
cat $drv_temp| sed -En "s/^.*href.*'(.*)\/'>.*$/\1/p" > $drv_list
cat $drv_temp| sed -En "s/^.*href.*'(.*)\/'>.*$/\1/p"| tail -n1 > $last_beta
LAST_DRV=$(cat $last_update | awk '{ print $1 }')
LAST_BETA=$(cat $last_beta)

## driver version could be in the form xxx.xxx.xxx or xxx.xx
## it is needed to short it to number only.
offi_short=$(echo "$LAST_DRV"| sed -n "s|\.||g;p")
beta_short=$(printf "$LAST_BETA"| sed -n "s|\.||g;p")
if [ -s $nvdir/version.txt ]; then
	version=$(cat $nvdir/version.txt)
# 	ver_n=$(cat $nvdir/version.txt| sed -n "s|\.||g;p" | wc -m)
else
	version=$(modinfo -F version nvidia)
# 	ver_n=$(( $(sed -n "s|\.||g;p" <<< $version | wc -m)-1 ))
fi
## read from standard output print a extra line. We remove it with -1 in calculs.
ver_n=$(( $(sed -n "s|\.||g;p" <<< $version | wc -m)-1 ))
ver_short=$(echo "$version"| sed -n "s|\.||g;p")
ver_diff=$(($nb-$ver_n))
n=0
until [ $n = $ver_diff ]; do
	ver_short=$(echo $ver_short'0')
	((n++))
done
bet_n=$(( $(wc -m <<< "$offi_short")-1))
off_n=$(( $(wc -m <<< "$beta_short")-1))

off_diff=$(($nb-$off_n))
bet_diff=$(($nb-$bet_n))
n=0
until [ $n = $off_diff ]; do
	offi_short=$(echo $offi_short'0')
	((n++))
done
n=0
until [ $n = $bet_diff ]; do
	beta_short=$(echo $beta_short'0')
	((n++))
done
# eval if beta is different than offi.
[ $beta_short -ne $offi_short ]|| beta_short=0
# be sure that version found are a non 0 value.
[ $beta_short -gt 0 ]|| beta_short=0
[ $ver_short -gt 0 ]|| ver_short=0

if [ $beta_short -gt 0 ]&&[ $beta_short -ne $offi_short ]; then
	DRV_LIST=( "$LAST_DRV, official driver,$offi_short" "$LAST_BETA, beta driver,$beta_short" )
else
	DRV_LIST=( "$LAST_DRV, official drivers,$offi_short" )
fi
if [ ${#DRV_LIST[@]} -gt 0 ]; then
	IFS=$(echo -en "\n\b")
	cnt=0
	for drv_line in ${DRV_LIST[@]}; do
		driver=$(printf "$drv_line"|cut -d',' -f1)
		release=$(printf "$drv_line"|cut -d',' -f2)
		drv_short=$(printf "$drv_line"|cut -d',' -f3)
		if [ $drv_short -gt $ver_short ]; then
			if [ $cnt -eq 0 ]; then sol='';eol=''; else sol='\n';eol=''; fi
			if [[ $(egrep -c "$driver" $drv_list) -gt 0 ]]; then
				_driver_notif+=( "$sol<b>$driver</b> $release update.$eol" )
			else
				_driver_notif+=( "$sol<b>$driver</b> $release update.\n<i>(not dowloadable yet)</i>$eol" )
			fi
			((cnt++))
		fi
	done
	if [[ $drv_short -gt $ver_short || ! $(echo -e "${DRV_LIST[*]}") =~ $(modinfo -F version nvidia) ]]; then
		notif_msg+='Nvidia driver '
		driver_up=1
	fi
	IFS=$ifs
fi
}
source_ctrl(){
	if [ $driver_up -gt 0 ]; then
	notif_txt='and Zenvidia'; line='\n'
	else
	notif_txt='Zenvidia'; line=''
	fi
 	rep_git_local=$(find -P $HOME -maxdepth 4 -name "zenvidia" -type d)
	tmp_git_src=$(mktemp -d --tmpdir tmp_git.XXX)
	test -f $local_src/zen_git.log || touch $local_src/zen_git.log
	IFS=$(echo -en "\n\b")
	CHECK_GIT_REPO(){
		local_date=$(env LANG=En_en date +%Y''%m''%d)
		# extract date from log
		git_rm_fetch_date=$(git log origin -n 1 | sed -n '/Date/p'| awk '{print $3" "$4" "$6}')
		# convert date to comparable number
		git_rm_date=$(date -d "$git_rm_fetch_date" +%Y''%m''%d)
		# extract version line
		git_rm_version=$(git log origin -n 1 | egrep -o "v[0-9].[0-9].[0-9]{,2}")
		git_local_version=$(cat $local_nvdir/zen_version)
 		git_rm_fetch_log=$(git log origin -n 1 | sed -n "/-/,/-/p")
		# before acting, we need to know the last pull record in local dir.
		if [ $rep_git_local ]; then
			pushd $rep_git_local
			git_local_pull_date=$(cat .git/logs/refs/heads/master| grep "clone\|pull"|awk '{print $5}'|sed -n '$p')
			git_pull_date=$(date -d "@$git_local_pull_date" +%Y''%m''%d)
			if [ ! "$git_local_version" ]; then
				git_local_version=$(git log origin -n 1 | egrep -o "v[0-9].[0-9].[0-9]{,2}")
				test "$git_local_version" || git_local_version=0
				echo -e "$git_local_version" > $local_nvdir/zen_version
			fi
			popd
		else
			git_pull_date=0
			git_local_version=0
		fi
		# then, we need to know if log is about version update or issue warning message.
		# log and issue is mandatory formated with a '-' in commit message.
		if [ ${#git_rm_fetch_log[*]} -gt 0 ]; then
			if [ "$git_rm_version" ]&&[ "$git_rm_version" != "$git_local_version" ]; then
				if [ $(grep -c "$git_rm_fetch_date" $local_src/zen_git.log) -eq 0 ]; then
					if [ $(grep -c "-" <<< ${git_rm_fetch_log[*]}) -gt 0 ]; then
						cat <<-LOG >> $local_src/zen_git.log
							$git_rm_fetch_date :$git_rm_version
							$git_rm_fetch_log
						LOG
					fi
				fi
				issue=0
			else
				if [ $(grep -c "issue" <<< ${git_rm_fetch_log[*]}) -gt 0 ]; then
					issue=1
					git_rm_warn_log=$(cut -d'-' -f2 <<< ${git_rm_fetch_log[*]})
				fi
			fi
		fi
			# if last pull/clone date is lower than the remote's, display update message.
			if [ $git_pull_date -lt $git_rm_date ]; then
				zen_up=1
				# is the log message an issue warning ?
				if [ $issue = 0 ]; then
					notif_msg+="$notif_txt "
					_driver_notif+=("$line\zenvidia git repo update.\n$git_rm_fetch_date $git_rm_version")
				else
					notif_msg+="$notif_txt "
					_driver_notif+=("$line\zenvidia git warning.\n$git_rm_fetch_date $git_rm_warn_log")
				fi
			fi
	}
	# clone remote .git dir only to get changes.
	pushd $tmp_git_src
	git clone -n --depth=1 $zenvidia_git .
	# then check diff in date, then in data, if local repos exist.
	CHECK_GIT_REPO
	popd
	IFS=$ifs
}
notifying(){
	# only display notif if driver_ctrl or source_ctrl are true.
	if [[ $driver_up -gt 0 || $zen_up -gt 0 ]]; then
		notify-send -t 5000 -u low -i $icon_set "${notif_msg[*]}update" "$(echo "${_driver_notif[@]}")"
	fi
}
usage_help(){
	printf "# Usage : zen_notify option,where option is:\n"
	printf "\t -z : check nvidia & zenvidia.\n"
	printf "\t -n : check nvidia only.\n"
	printf "\t -h : this help.\n"
}
icon_set=$deficon
test $# -gt 0 || usage_help
while [ $# -gt 0 ]
	getopts "z n h" OPT; do
	case $OPT in
		z)
		driver_ctrl
		source_ctrl
		notifying
		;;
		n)
		driver_ctrl
		notifying
		;;
		h) usage_help ;;
	esac
done
